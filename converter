import React, { useState } from 'react';
import { ArrowRightLeft, Zap, Activity, CheckCircle, XCircle } from 'lucide-react';

export default function TransmissionConverter() {
  const [mode, setMode] = useState('mToT'); // 'mToT' or 'tToM'
  const [rangeMin, setRangeMin] = useState(0);
  const [rangeMax, setRangeMax] = useState(100);
  const [units, setUnits] = useState('PSI');
  const [inputValue, setInputValue] = useState('');
  const [result, setResult] = useState(null);
  const [showExplanation, setShowExplanation] = useState(false);
  const [quizMode, setQuizMode] = useState(false);
  const [quizAnswer, setQuizAnswer] = useState('');
  const [quizFeedback, setQuizFeedback] = useState(null);

  // Standard transmission range: 4-20 mA
  const TRANS_MIN = 4;
  const TRANS_MAX = 20;

  const calculateTransmission = (measurement) => {
    const meas = parseFloat(measurement);
    if (isNaN(meas)) return null;
    
    const span = rangeMax - rangeMin;
    let transmission = TRANS_MIN + ((meas - rangeMin) / span) * (TRANS_MAX - TRANS_MIN);
    
    // Clamp transmission between 3.9 and 22 mA
    transmission = Math.max(3.9, Math.min(22, transmission));
    
    return transmission.toFixed(2);
  };

  const calculateMeasurement = (transmission) => {
    const trans = parseFloat(transmission);
    if (isNaN(trans)) return null;
    
    const span = rangeMax - rangeMin;
    const measurement = rangeMin + ((trans - TRANS_MIN) / (TRANS_MAX - TRANS_MIN)) * span;
    return measurement.toFixed(2);
  };

  const handleCalculate = () => {
    if (!inputValue) return;
    
    let calculated;
    if (mode === 'mToT') {
      calculated = calculateTransmission(inputValue);
    } else {
      calculated = calculateMeasurement(inputValue);
    }
    
    setResult(calculated);
    setShowExplanation(true);
    setQuizMode(false);
    setQuizFeedback(null);
  };

  const generateQuiz = () => {
    const randomMeas = Math.floor(Math.random() * (rangeMax - rangeMin) + rangeMin);
    const correctAnswer = calculateTransmission(randomMeas);
    
    setInputValue(randomMeas.toString());
    setResult(null);
    setQuizAnswer('');
    setQuizFeedback(null);
    setQuizMode(true);
    setMode('mToT');
  };

  const checkQuizAnswer = () => {
    const correctAnswer = calculateTransmission(inputValue);
    const userAnswer = parseFloat(quizAnswer);
    
    if (Math.abs(userAnswer - parseFloat(correctAnswer)) < 0.1) {
      setQuizFeedback({ correct: true, answer: correctAnswer });
    } else {
      setQuizFeedback({ correct: false, answer: correctAnswer });
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h1 className="text-3xl font-bold text-indigo-900 mb-2">
            Measurement ‚áÑ Transmission Converter
          </h1>
          <p className="text-gray-600 mb-6">
            Master the art of converting between measurement values and transmission signals (4-20 mA)
          </p>

          {/* Instrument Range Setup */}
          <div className="bg-indigo-50 rounded-lg p-6 mb-6">
            <h2 className="text-lg font-semibold text-indigo-900 mb-4">Instrument Range Setup</h2>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Min Value</label>
                <input
                  type="number"
                  value={rangeMin}
                  onChange={(e) => {
                    const val = e.target.value === '' || e.target.value === '-' ? e.target.value : parseFloat(e.target.value);
                    setRangeMin(val);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Max Value</label>
                <input
                  type="number"
                  value={rangeMax}
                  onChange={(e) => {
                    const val = e.target.value === '' || e.target.value === '-' ? e.target.value : parseFloat(e.target.value);
                    setRangeMax(val);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Units</label>
                <select
                  value={units}
                  onChange={(e) => setUnits(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                >
                  <option>PSI</option>
                  <option>¬∞F</option>
                  <option>¬∞C</option>
                  <option>GPM</option>
                  <option>%</option>
                </select>
              </div>
            </div>
          </div>

          {/* Mode Selection */}
          {!quizMode && (
            <div className="flex gap-4 mb-6">
              <button
                onClick={() => setMode('mToT')}
                className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${
                  mode === 'mToT'
                    ? 'bg-indigo-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                <Zap size={20} />
                Measurement ‚Üí Transmission
              </button>
              <button
                onClick={() => setMode('tToM')}
                className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${
                  mode === 'tToM'
                    ? 'bg-indigo-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                <Activity size={20} />
                Transmission ‚Üí Measurement
              </button>
            </div>
          )}

          {/* Calculator Interface */}
          {!quizMode && (
            <div className="bg-gray-50 rounded-lg p-6 mb-6">
              <div className="flex items-center gap-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    {mode === 'mToT' ? `Enter Measurement (${units})` : 'Enter Transmission (mA)'}
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"
                    placeholder={mode === 'mToT' ? `${rangeMin}-${rangeMax}` : '4-20'}
                  />
                </div>
                <ArrowRightLeft className="text-indigo-600 mt-6" size={24} />
                <div className="flex-1">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    {mode === 'mToT' ? 'Transmission (mA)' : `Measurement (${units})`}
                  </label>
                  <div className="px-4 py-3 bg-white border-2 border-indigo-300 rounded-lg text-lg font-semibold text-indigo-900">
                    {result || '---'}
                  </div>
                </div>
              </div>
              <button
                onClick={handleCalculate}
                className="w-full mt-4 bg-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-indigo-700 transition-colors"
              >
                Calculate
              </button>
            </div>
          )}

          {/* Quiz Mode */}
          {quizMode && (
            <div className="bg-yellow-50 rounded-lg p-6 mb-6 border-2 border-yellow-300">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-yellow-900">üéØ Quiz Challenge</h3>
                <button
                  onClick={() => setQuizMode(false)}
                  className="text-gray-600 hover:text-gray-800 px-3 py-1 rounded-lg hover:bg-yellow-100 transition-colors"
                >
                  ‚Üê Back to Calculator
                </button>
              </div>
              <p className="text-gray-700 mb-4">
                If the measurement is <span className="font-bold text-2xl text-indigo-900">{inputValue} {units}</span>, what should the transmission signal be?
              </p>
              <div className="flex gap-4 items-end">
                <div className="flex-1">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Your Answer (mA)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={quizAnswer}
                    onChange={(e) => setQuizAnswer(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-lg"
                    placeholder="Enter mA value"
                  />
                </div>
                <button
                  onClick={checkQuizAnswer}
                  className="bg-yellow-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-yellow-700 transition-colors"
                >
                  Check Answer
                </button>
              </div>
              
              {quizFeedback && (
                <div className={`mt-4 p-4 rounded-lg flex items-center gap-3 ${
                  quizFeedback.correct ? 'bg-green-100 text-green-900' : 'bg-red-100 text-red-900'
                }`}>
                  {quizFeedback.correct ? <CheckCircle size={24} /> : <XCircle size={24} />}
                  <div>
                    <p className="font-semibold">
                      {quizFeedback.correct ? '‚úì Correct!' : '‚úó Not quite right'}
                    </p>
                    <p>The correct answer is {quizFeedback.answer} mA</p>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Explanation */}
          {showExplanation && result && !quizMode && (
            <div className="bg-green-50 rounded-lg p-6 mb-6 border-2 border-green-300">
              <h3 className="text-lg font-semibold text-green-900 mb-3">üìñ How This Works</h3>
              {mode === 'mToT' ? (
                <div className="text-gray-700 space-y-2">
                  <p><strong>Checking Transmitter:</strong> At {inputValue} {units}, the transmitter should output {result} mA.</p>
                  <p className="text-sm">Formula: 4 + ((Value - {rangeMin}) / {rangeMax - rangeMin}) √ó 16 = {result} mA</p>
                  <p className="text-sm text-green-800 mt-3">
                    <strong>Real-world use:</strong> If your transmitter reads {inputValue} {units} but outputs a different mA signal, it needs calibration or repair.
                  </p>
                </div>
              ) : (
                <div className="text-gray-700 space-y-2">
                  <p><strong>Checking Receiver:</strong> A {inputValue} mA signal should display {result} {units}.</p>
                  <p className="text-sm">Formula: {rangeMin} + (({inputValue} - 4) / 16) √ó {rangeMax - rangeMin} = {result} {units}</p>
                  <p className="text-sm text-green-800 mt-3">
                    <strong>Real-world use:</strong> Inject a {inputValue} mA test signal into the receiver. It should display {result} {units}.
                  </p>
                </div>
              )}
            </div>
          )}

          {/* Practice Button */}
          <button
            onClick={generateQuiz}
            className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:from-purple-700 hover:to-indigo-700 transition-colors"
          >
            üé≤ Generate Practice Problem
          </button>
        </div>

        {/* Quick Reference Card */}
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">Quick Reference</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="bg-blue-50 p-4 rounded-lg">
              <h3 className="font-semibold text-blue-900 mb-2">Standard Transmission</h3>
              <p className="text-sm text-gray-700">4 mA = Minimum measurement</p>
              <p className="text-sm text-gray-700">20 mA = Maximum measurement</p>
              <p className="text-sm text-gray-700">12 mA = Mid-range (50%)</p>
            </div>
            <div className="bg-purple-50 p-4 rounded-lg">
              <h3 className="font-semibold text-purple-900 mb-2">Troubleshooting Tips</h3>
              <p className="text-sm text-gray-700">‚Ä¢ 3.8 mA or below = Wire break</p>
              <p className="text-sm text-gray-700">‚Ä¢ 21+ mA = Fault or over-range</p>
              <p className="text-sm text-gray-700">‚Ä¢ Drifting signal = Calibration needed</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
